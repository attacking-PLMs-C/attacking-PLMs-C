import os
import argparse
import tqdm
import operator
import json

def get_mutated_path(root_path):
    with open(root_path, 'r') as fp:
        all_lines = fp.read().strip().split('\n')
    return all_lines

if  __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('action', type=str)
    args = parser.parse_args()

    if args.action == '1':
        t_dir = 'code_rename'
    elif args.action == '12':
        t_dir = 'code_redefine'
    else:
        t_dir = 'code_exchange'
    root_path = '../Transformation' + args.action + '/true_mutated' + args.action + '.txt'
    path2 = '../Transformation' + args.action + '/true_mutated2.txt'
    path5 = '../Transformation' + args.action + '/true_mutated5.txt'
    path7 = '../Transformation' + args.action + '/true_mutated7.txt'
    
    file_trans_count = {}
    file_to_trans = {}
    file_list1 = get_mutated_path(root_path)
    file_list2 = get_mutated_path(path2)
    file_list5 = get_mutated_path(path5)
    file_list7 = get_mutated_path(path7)
    # print(file_list7)
    for fname in tqdm.tqdm(file_list1):
        # print(fname)
        o_fname = fname.split('-')[0] + '.c'
        if o_fname not in file_to_trans:
            file_to_trans[o_fname] =  [fname]
        elif fname not in file_to_trans[o_fname]:
            file_to_trans[o_fname].append(fname)

        if o_fname not in file_trans_count:
            file_trans_count[o_fname] = 1
        else:
            file_trans_count[o_fname] += 1
        
        if fname in file_list2:
            file_trans_count[o_fname] += 1
        if fname in file_list5:
            file_trans_count[o_fname] += 1
        if fname in file_list7:
            file_trans_count[o_fname] += 1

    all_mutated_files = [file_list2, file_list5, file_list7]
    file_trans_count = dict(sorted(file_trans_count.items(), key=operator.itemgetter(1)))
    cnt = 0
    with open('./' + t_dir + '/valid_testcases.txt', 'w') as fp: 
        for k, v in file_trans_count.items():
            if v >= 1:
                fp.write(k + '\n')
                cnt += 1
    print(cnt)
    print(len(file_trans_count))
    with open('Transfomation' + args.action + '_msg.json', 'w') as fp:
        json.dump(file_trans_count, fp)

    with open('./' + t_dir + '/file_to_transformations.json', 'w') as fp:
        json.dump(file_to_trans, fp)
    
    with open('./' + t_dir + '/all_mutated_files.json', 'w') as fp:
        json.dump(all_mutated_files, fp)
import os
import tree_sitter
import tqdm
from utils import *
from pprint import pprint
from difflib import Differ
import ast

'''从github下载tree-sitter-c文件，使用以下命令编译语言存储库'''
tree_sitter.Language.build_library(
  # Store the library in the `build` directory
  './my_parser/my-languages.so',

  # Include one or more languages
  ['./my_parser/tree-sitter-c']
)

"加载c语言语法树"
LANG = tree_sitter.Language('./my_parser/my-languages.so', 'c')

"初始化Tree-sitter解析器"
parser = tree_sitter.Parser()
parser.set_language(LANG)


# def main():
#     file_path_list = get_file_path('../norm_code', [])
#     # print(len(path_list))
#     # print(path_list)
#     bar = tqdm.tqdm(file_path_list)
#     for path in bar:
#         fname = path.split('/')[-1]
#         fcode = open(path, 'r').read().strip()
#         ftree = parser.parse(bytes(fcode, 'utf-8'))

#         # root_node = ftree.root_node
#         for node in ftree.root_node.children:
#             print(fcode[node.start_byte:node.end_byte])
#             break
#         break
#         bar.update()
#     bar.close()

# # 对 C 代码文件进行解析，返回语法树和根节点
# def parse_file(filename):
#     try:
#         with open(filename, 'r') as f:
#             content = f.read().strip()
#         tree = parser.parse(content)
#         return tree.root_node
#     except Exception as e:
#         print(e)
#         return None, None

# # 获取所有的行内容
# def get_lines(node):
#     lines = []
#     if node != None:
#         for child in node.children:
#             if child.is_named():
#                 lines.extend(get_lines(child))
#             else:
#                 lines.append(node)
#     return lines

# # 获取代码文件中的所有行内容
# def get_all_lines(filename):
#     _, root = parse_file(filename, LANG)
#     lines = get_lines(root)
#     return lines

# # 找出两个 C 代码文件之间的不同行
# def diff_code(filename1, filename2):
#     lines1 = get_all_lines(filename1)
#     lines2 = get_all_lines(filename2)
#     differ = Differ()
#     diff = differ.compare(lines1, lines2)
#     diff_list = list(diff)
#     res = []
#     for i, line in enumerate(diff_list):
#         if line.startswith('-') or line.startswith('+'):
#             res.append((i + 1, line.strip()))
#     return res



def main():
    file_path_list = get_file_path('../norm_code', [])
    code1 = '../norm_code/0a90b6a43e76aec8031b6c8a46bba2bf6cd25fa7_00665.c'
    code2 = '../Transformation1/mutated_code1/0a90b6a43e76aec8031b6c8a46bba2bf6cd25fa7_00665-1.c'
    # diffs = diff_code(code1, code2)
    # print(diffs)
    # for diff in diffs:
    #     print(diff)
    with open(code1, 'r') as f:
        content1 = f.read().strip()
    tree1 = parser.parse(bytes(content1,'utf-8'))
    # tree1 = tree1.root_node
    print(tree1)
    for node in tree1.visitor():
        if node.type == 'identifier':
            print(node)

if __name__ == "__main__":
    main()
import os
import json
import tqdm
import re
from collections import Counter
import operator
import random
import argparse
import pandas as pd
import subprocess
import itertools
from multiprocessing import Pool

def get_file_path(root_path, file_list):
    PATH = os.listdir(root_path)
    for path in PATH:
        # print(path)
        co_path = os.path.join(root_path, path)
        if os.path.isfile(co_path):
            file_list.append(co_path)
        elif os.path.isdir(co_path):
            get_file_path(co_path, file_list)
    return file_list

def get_file_list(root_path, file_list):
    with open(root_path, 'r') as fp:
        all_lines = fp.read().strip().split('\n')
        for line in all_lines:
            file_list.append(line)
    return file_list

def get_data(code_data):
    code_data = re.sub(r"(\s)+", '', code_data).strip()  # [\n ]+
    return code_data

def mutation_count(source_path1, source_path2, target_path):
    all_files = []
    mutated_files = []
    get_file_path(source_path1, all_files)
    get_file_path(source_path2, mutated_files)
    print(len(mutated_files))
    print(len(all_files))

    bar = tqdm.tqdm(mutated_files)
    with open(target_path, 'w') as fp:
        for path in bar:
            fname = path.split('/')[-1]
            if source_path1 == '../initial_code':
                s_path = source_path1 + '/' + fname.split('-')[0] + '.c'
            else:
                s_path = source_path1 + '/' + fname
            f_mutated = open(path,'r').read().strip()
            f_mutated = get_data(f_mutated)
            f_source = open(s_path, 'r').read().strip()
            f_source = get_data(f_source)
            if f_mutated != f_source:
                fp.write(path.split('/')[-1] + '\n')
            bar.update()
        bar.close()

if __name__ == "__main__":
    # file_path_list = []
    # get_file_path('../initial_code', file_path_list)
    # bar = tqdm.tqdm(total=len(file_path_list))
    # for i, path in  enumerate(file_path_list):
    #     fname = path.split('/')[-1]
    #     fid = fname.split('.')[0]
    #     subprocess.check_output('./runner1.sh ' + path + ' ' + fname + ' 1 ' + fid, shell=True)
    #     bar.update()
    # bar.close()
    # mutation_count('../initial_code', '../mutated_candidates/mutated_code1', '../mutated_candidates/true_mutated1.txt')

    file_path_list3 = []
    get_file_list('../mutated_candidates/true_mutated1_12.txt', file_path_list3)
    bar6 = tqdm.tqdm(total=len(file_path_list3))
    for i, fname in  enumerate(file_path_list3):
        path = '../mutated_candidates/mutated_code1_12/' + fname
        t_dir1 = '../../mutated_candidates/mutated_code1_12_2/'
        #t_dir2 = '../not_mutated_code1_2_12/'
        subprocess.check_output('./runner2.sh ' + path + ' ' + fname + ' 2 ' + t_dir1, shell=True)
        bar6.update()
    bar6.close()
    mutation_count('../mutated_candidates/mutated_code1_12', '../mutated_candidates/mutated_code1_12_2', '../mutated_candidates/true_mutated1_12_2.txt')

    file_path_list5 = []
    get_file_list('../mutated_candidates/true_mutated1_12_2.txt', file_path_list5)
    bar8 = tqdm.tqdm(total=len(file_path_list5))
    for i, fname in  enumerate(file_path_list5):
        path = '../mutated_candidates/mutated_code1_12_2/' + fname
        t_dir1 = '../../mutated_candidates/mutated_code1_12_2_3/'
        #t_dir2 = '../not_mutated_code1_2_3_12/'
        subprocess.check_output('./runner2.sh ' + path + ' ' + fname + ' 3 ' + t_dir1, shell=True)
        bar8.update()
    bar8.close()
    mutation_count('../mutated_candidates/mutated_code1_12_2', '../mutated_candidates/mutated_code1_12_2_3', '../mutated_candidates/true_mutated1_12_2_3.txt')

    file_path_list5 = []
    get_file_list('../mutated_candidates/true_mutated1_12_2_3.txt', file_path_list5)
    bar8 = tqdm.tqdm(total=len(file_path_list5))
    for i, fname in  enumerate(file_path_list5):
        path = '../mutated_candidates/mutated_code1_12_2_3/' + fname
        t_dir1 = '../../mutated_candidates/mutated_code1_12_2_3_7/'
        #t_dir2 = '../not_mutated_code1_2_3_7_12/'
        subprocess.check_output('./runner2.sh ' + path + ' ' + fname + ' 7 ' + t_dir1, shell=True)
        bar8.update()
    bar8.close()
    mutation_count('../mutated_candidates/mutated_code1_12_2_3', '../mutated_candidates/mutated_code1_12_2_3_7', '../mutated_candidates/true_mutated1_12_2_3_7.txt')